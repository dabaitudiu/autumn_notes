# 一、 经典问题：输入URL回车之后，究竟发生了什么

## 大致流程
1. URL 解析
2. DNS 查询
3. TCP 连接
4. 处理请求
5. 接受响应
6. 渲染页面

### 参考
[一次完整的HTTP请求过程](https://zhuanlan.zhihu.com/p/38240894)

## 答案样例
### 1. URL解析
首先，浏览器会对输入的URL进行解析，判断输入的是合法的地址还是待搜索的关键词。其次，如果浏览器包含此网页的缓存且缓存没有过期，则会直接返回该缓存。
### 2. DNS查询
如果输入的是非IP地址，浏览器会进行DNS查询。DNS服务是和HTTP协议一样位于应用层的协议。它提供域名到IP地址之间的解析。用户通常使用主机名或域名来访问对方的计算机，而不是通过IP地址访问。域名解析的过程是逐级查询的，有如下几级的缓存：
- （1）浏览器缓存：浏览器会查找上一次访问这个地址时的记录，如果有那直接返回
- （2）操作系统缓存：查找存储在系统运行内存/host文件中的缓存
- （3）路由器缓存：访问过的域名会存在路由器上
- （4）ISP DNS缓存： 互联网服务提供商（如中国电信）也会提供DNS服务，比如比较著名的 114.114.114.114，在本地查找不到的情况下，就会向ISP进行查询，ISP会在当前服务器的缓存内查找是否有记录，如果有，则返回这个IP，若没有，则会开始向根域名服务器请求查询
- （5）根DNS服务器：根域名收到请求后，会判别这个域名(.com)是授权给哪台服务器管理,并返回这个顶级DNS服务器的IP。请求者收到这台顶级DNS的服务器IP后，会向该服务器发起查询，如果该服务器无法解析，该服务器就会返回下一级的DNS服务器IP（nicefilm.com），本机继续查找，直到服务器找到(www.nicefilm.com)的主机
### 3. TCP连接
TCP连接：这篇讲的非常之详细->[三次握手，四次挥手](https://zhuanlan.zhihu.com/p/103000747)
### 4. HTTP请求
客户端发起HTTP请求
#### 先介绍一下HTTP: 
通俗来讲，他就是计算机通过网络进行通信的规则，是一个基于请求与响应，无状态的，应用层的协议，常基于TCP/IP协议传输数据。目前任何终端（手机，笔记本电脑。。）之间进行任何一种通信都必须按照Http协议进行，否则无法连接。
- 请求与响应：客户端发送请求，服务端相应数据
- 无状态的：协议对于事务处理没有记忆能力，每次请求都要重新建立连接
- 应用层：Http是属于应用层的协议
- TCP/IP: Http使用TCP作为它的支撑运输协议。HTTP客户机发起一个与服务器的TCP连接，一旦连接建立，浏览器（客户机）和服务器进程就可以通过socket接口访问TCP
#### HTTP请求报文：
在应用层，浏览器会分析这个url,并设置好请求报文发出。请求报文中包括报文组成：请求行，请求头部，空行，请求数据
1. 请求行：请求方法、请求地址、协议版本
    - 请求方法: GET,HEAD,POST,PUT,PATCH,DELETE,OPTIONS,CONNECT,TRACE。HEAD:与GET相似，但只获取报文首部；PUT:上传文件，但不带验证机制，任何人都能传，存在安全问题。PATCH:与PUT相似，PUT也可以修改资源，但只能完全替代原始资源，PATCH允许部分修改
    - 请求地址: 协议（http://），主机（localhost)，路径(/index.html)，参数（key=value)。
    - 协议版本: HTTP/1.0 或 HTTP/1.1
2. 请求头部：为请求报文添加了一些附加信息,比如：
    - Host: 接受请求的服务器地址，可以是IP端口号，也可以是域名
    - User-Agent: 发送请求的应用程序名称
    - Connection: 指定与连接相关的属性,比如Connection: Keep-Alive
3. 请求数据：可选，GET就没有请求数据。POST方法的请求数据可以是类似于username=aa&password=1234
### 5. HTTP响应
在接收和解释请求消息后，服务器返回一个HTTP响应消息。 HTTP 响应由三个部分组成，分别是：状态行、消息报头、响应正文
1. 状态行: 由3部分组成，分别为：协议版本、状态码、状态码描述
    - 协议版本：跟请求报文一致
    - 状态码描述：对状态码的简单描述
    - 状态码：常用的：
        - 100 Continue：一切正常，可以接收或忽略响应；
        - 200 OK：响应成功；
        - 301 Moved Permanently：永久重定向，
        - 302 Found：临时重定向；
        - 400 Bad Request：客户端有语法错误，不能被服务器识别；
        - 403 Forbidden：请求被拒绝；
        - 404 Not Found：请求资源不存在；
        - 500 Internal Server Error：服务器内部错误; 
        - 503 Service Unavailable: 服务器暂时处于超负载或正在进行停机维护，现在无法处理请求
2. 响应头部：与请求头部类似，为响应报文添加了一些附加信息
    - Server: 服务器应用程序软件的名称和版本
    - Content-Type: 响应正文的类型（图片还是二进制字符串)
    - Content-Lenth: 响应正文长度。等等。
3. 响应数据：用于存放需要返回给客户端的数据信息，比如HTML文件
### 6.渲染页面
在浏览器没有完整接受全部 HTML 文档时，它就已经开始显示这个页面了，不同浏览器可能解析的过程不太一样，这里我们只介绍 WebKit 的渲染过程。
1. 解析HTML，构建 DOM 树
2. 解析 CSS ，生成 CSS 规则树
3. 合并 DOM 树和 CSS 规则，生成 render 树
4. 布局 render 树（ Layout / reflow ），负责各元素尺寸、位置的计算
5. 绘制 render 树（ paint ），绘制页面像素信息
6. 浏览器会将各层的信息发送给 GPU，GPU 会将各层合成（ composite ），显示在屏幕上

需要注意的是，这是一个渐进的过程，呈现引擎为了力求显示的及时，会在文档请求不完全的情况下就开始渲染页面，同时，如果在解析的过程中遇到script的时候，文档的解析将会停止下来，立即解析执行脚本，如果脚本是外部的，则会等待请求完成并解析执行。所以，为了不阻塞页面地呈现，一般会把script脚本放在文档的最后。